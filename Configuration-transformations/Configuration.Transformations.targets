<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="Package.Version.targets" />
	<PropertyGroup>
		<PackageWebTemplateConfig>$(SolutionDir)packages\EPiServer-Application-Files.$(PackageVersion)\Configuration\Web.Template.config</PackageWebTemplateConfig>
	</PropertyGroup>
	<!-- The built in transformation functionality for package/publish needs the Web.config, so we transform ..\packages\EPiServer-Application-Files.X.X.X.X\Configuration\Web.Template.config with Web.Common.config into Web.Template.config and then we copy Web.Template.config to Web.config after PipelineCollectFilesPhase. -->
	<Target
		Name="CopyWebTemplateConfigToWebConfig"
		AfterTargets="PipelineCollectFilesPhase"
		Condition="Exists('Web.Template.config')"
		DependsOnTargets="TransformPackageWebTemplateConfigWithWebCommonConfigToWebTemplateConfig"
	>
		<Message
			Importance="high"
			Text="Copying Web.Template.config to Web.config."
		/>
		<Copy
			DestinationFiles="Web.config"
			SourceFiles="Web.Template.config"
		/>
	</Target>
	<Target Name="TransformPackageWebTemplateConfigWithWebCommonConfigToWebTemplateConfig">
		<Message
			Condition="Exists('$(PackageWebTemplateConfig)') AND !Exists('Web.Common.config')"
			Importance="high"
			Text="Copying $(PackageWebTemplateConfig) to Web.Template.config."
		/>
		<Copy
			Condition="Exists('$(PackageWebTemplateConfig)') AND !Exists('Web.Common.config')"
			DestinationFiles="Web.Template.config"
			SourceFiles="$(PackageWebTemplateConfig)"
		/>
		<Message
			Condition="Exists('$(PackageWebTemplateConfig)') AND Exists('Web.Common.config')"
			Importance="high"
			Text="Transforming $(PackageWebTemplateConfig) with Web.Common.config to Web.Template.config."
		/>
		<TransformXml
			Condition="Exists('$(PackageWebTemplateConfig)') AND Exists('Web.Common.config')"
			Destination="Web.Template.config"
			Source="$(PackageWebTemplateConfig)"
			StackTrace="True"
			Transform="Web.Common.config"
		/>
	</Target>
	<!-- Before running the application we transform -->
	<Target
		Name="ConfigTransform"
		BeforeTargets="PrepareForRun"
		DependsOnTargets="TransformPackageWebTemplateConfigWithWebCommonConfigToWebTemplateConfig"
	>
		<ItemGroup>
			<ConfigName Include="Web" />
			<ConfigName Include="log4net" />
		</ItemGroup>
		<Message
			Condition="Exists('%(ConfigName.Identity).Template.config') AND Exists('%(ConfigName.Identity).$(Configuration).config')"
			Importance="high"
			Text="Transforming %(ConfigName.Identity).Template.config with %(ConfigName.Identity).$(Configuration).config to %(ConfigName.Identity).config."
		/>
		<TransformXml
			Condition="Exists('%(ConfigName.Identity).Template.config') AND Exists('%(ConfigName.Identity).$(Configuration).config')"
			Destination="%(ConfigName.Identity).config"
			Source="%(ConfigName.Identity).Template.config"
			StackTrace="True"
			Transform="%(ConfigName.Identity).$(Configuration).config"
		/>
		<Message
			Condition="Exists('%(ConfigName.Identity).Template.config') AND !Exists('%(ConfigName.Identity).$(Configuration).config')"
			Importance="high"
			Text="Copying %(ConfigName.Identity).Template.config to %(ConfigName.Identity).config."
		/>
		<Copy
			Condition="Exists('%(ConfigName.Identity).Template.config') AND !Exists('%(ConfigName.Identity).$(Configuration).config')"
			DestinationFiles="%(ConfigName.Identity).config"
			SourceFiles="%(ConfigName.Identity).Template.config"
		/>
	</Target>
	<Target
		Name="ExcludeConfigTransformFiles"
		BeforeTargets="ExcludeFilesFromPackage"
	>
		<Message
			Importance="high"
			Text="ExcludeFromPackageFiles: @(ExcludeFromPackageFiles)"
		/>
		<ItemGroup>
			<ExcludeFromPackageFiles Include="*.*.config" />
		</ItemGroup>
	</Target>
</Project>