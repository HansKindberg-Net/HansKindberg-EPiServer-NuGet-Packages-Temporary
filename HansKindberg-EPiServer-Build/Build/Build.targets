<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="..\..\Build\Package-Build.targets" />
	<Target Name="AfterBuildPackage">
		<ItemGroup>
			<TemporaryFile Include="$(PropertiesFileFullPath)" />
			<TemporaryFile Include="$(PropertiesTemplateFileFullPath)" />
			<TemporaryFile Include="$(TargetsFileFullPath)" />
		</ItemGroup>
		<Message
			Importance="$(MessageImportance)"
			Text="Target 'AfterBuildPackage': Deleting temporary file '%(TemporaryFile.Identity)'."
		/>
		<Delete
			Files="%(TemporaryFile.Identity)"
		/>
	</Target>
	<Target Name="BeforeBuildPackage">
		<Message
			Importance="$(MessageImportance)"
			Text="Target 'BeforeBuildPackage': Transforming '$(HansKindbergBuildPropertiesFile)' with '$(PropertiesTransformFileRelativePath)' to '$(PropertiesTemplateFileRelativePath)'."
		/>
		<TransformXml
			Destination="$(PropertiesTemplateFileRelativePath)"
			Source="$(HansKindbergBuildPropertiesFile)"
			Transform="$(PropertiesTransformFileRelativePath)"
		/>
		<Message
			Importance="$(MessageImportance)"
			Text="Target 'BeforeBuildPackage': Replacing tokens from '$(PropertiesTemplateFileRelativePath)' to '$(PropertiesFileRelativePath)'."
		/>
		<ItemGroup>
			<Token Include="PackageVersion">
				<ReplacementValue>$(Version)</ReplacementValue>
			</Token>
		</ItemGroup>
		<TemplateFile
			OutputFilename="$(PropertiesFileFullPath)"
			Template="$(PropertiesTemplateFileRelativePath)"
			Tokens="@(Token)"
		/>
		<Message
			Importance="$(MessageImportance)"
			Text="Target 'BeforeBuildPackage': Transforming '$(HansKindbergBuildTargetsFile)' with '$(TargetsTransformFileRelativePath)' to '$(TargetsFileRelativePath)'."
		/>
		<TransformXml
			Destination="$(TargetsFileRelativePath)"
			Source="$(HansKindbergBuildTargetsFile)"
			Transform="$(TargetsTransformFileRelativePath)"
		/>
	</Target>
	<Target Name="CreateNuGetPackage">
		<PropertyGroup>
			<Properties>Author="$(Author)"</Properties>
			<Properties>$(Properties);EPiServerVersion="$(EPiServerVersion)"</Properties>
			<Properties>$(Properties);Id="$(MSBuildProjectName)"</Properties>
			<Properties>$(Properties);Version="$(Version)"</Properties>
		</PropertyGroup>
		<Message
			Importance="$(MessageImportance)"
			Text="Target 'CreateNuGetPackage': Creating NuGet package '$(MSBuildProjectName).$(Version)' - properties = '$(Properties)'."
		/>
		<Exec
			Command='$(SolutionDir).nuget\NuGet.exe pack "$(MSBuildProjectName).nuspec" -OutputDirectory $(TargetDir) -Properties $(Properties) -Verbosity "$(NuGetVerbosity)"'
		/>
	</Target>
	<Target Name="DeployPackageContentToPackageDirectory">
		<Message
			Importance="$(MessageImportance)"
			Text="Target 'DeployPackageContentToPackageDirectory': Installing package '$(MSBuildProjectName).$(Version)' in '$(NuGetPackagesDirectory)'."
		/>
		<Exec
			Command='$(SolutionDir).nuget\NuGet.exe install $(MSBuildProjectName) -NoCache -OutputDirectory $(NuGetPackagesDirectory) -Prerelease -Source $(TargetDir) -Verbosity "$(NuGetVerbosity)" -Version "$(Version)"'
		/>
	</Target>
</Project>